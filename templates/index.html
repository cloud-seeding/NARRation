<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather Data Visualization</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        font-family: Arial, sans-serif;
      }

      .date-slider-container {
        width: 60px;
        padding: 20px;
        background: #f5f5f5;
        display: flex;
        flex-direction: column;
      }

      .main-container {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .controls {
        padding: 10px;
        background: #f5f5f5;
      }

      #map {
        flex: 1;
      }

      .level-slider-container {
        width: 60px;
        padding: 20px;
        background: #f5f5f5;
        display: flex;
        flex-direction: column;
      }

      .vertical-slider {
        writing-mode: bt-lr;
        -webkit-appearance: slider-vertical;
        width: 20px;
        height: 100%;
      }

      .legend {
        position: absolute;
        bottom: 20px;
        right: 100px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <div class="date-slider-container">
      <span>Date</span>
      <input type="range" id="dateSlider" class="vertical-slider" />
      <span id="dateValue"></span>
    </div>

    <div class="main-container">
      <div class="controls">
        <select id="variableSelect">
          <option value="air">Air Temperature</option>
          <option value="shum">Specific Humidity</option>
          <option value="omega">Omega</option>
          <option value="hgt">Height</option>
          <option value="uwnd">U Wind</option>
          <option value="vwnd">V Wind</option>
          <option value="fire_id_1">Fire ID</option>
        </select>
      </div>
      <div id="map"></div>
    </div>

    <div class="level-slider-container">
      <span>Level</span>
      <input type="range" id="levelSlider" class="vertical-slider" />
      <span id="levelValue"></span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
      let map;
      let dataRange;
      let markers = L.layerGroup();

      // Initialize map
      async function initMap() {
        map = L.map("map").setView([0, 0], 2);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(
          map
        );
        markers.addTo(map);

        // Get data ranges
        const response = await fetch("/data-range");
        dataRange = await response.json();

        // Initialize sliders
        initializeSliders();

        // Add event listeners
        map.on("moveend", fetchData);
        document
          .getElementById("variableSelect")
          .addEventListener("change", fetchData);
        document
          .getElementById("dateSlider")
          .addEventListener("input", fetchData);
        document
          .getElementById("levelSlider")
          .addEventListener("input", fetchData);

        // Initial data fetch
        fetchData();
      }

      function initializeSliders() {
        const dateSlider = document.getElementById("dateSlider");
        const levelSlider = document.getElementById("levelSlider");

        // Date slider setup
        const startDate = new Date(dataRange.date_range.min);
        const endDate = new Date(dataRange.date_range.max);
        dateSlider.min = startDate.getTime();
        dateSlider.max = endDate.getTime();
        dateSlider.value = startDate.getTime();

        // Level slider setup
        levelSlider.min = dataRange.level_range.min;
        levelSlider.max = dataRange.level_range.max;
        levelSlider.value = dataRange.level_range.min;

        updateSliderValues();
      }

      function updateSliderValues() {
        const dateValue = document.getElementById("dateValue");
        const levelValue = document.getElementById("levelValue");

        dateValue.textContent = new Date(
          Number(dateSlider.value)
        ).toLocaleDateString();
        levelValue.textContent = levelSlider.value;
      }

      async function fetchData() {
        const bounds = map.getBounds();
        const selectedVariable =
          document.getElementById("variableSelect").value;

        const params = new URLSearchParams({
          min_level: document.getElementById("levelSlider").value,
          max_level: document.getElementById("levelSlider").value,
          start_date: new Date(
            Number(document.getElementById("dateSlider").value)
          ).toISOString(),
          end_date: new Date(
            Number(document.getElementById("dateSlider").value)
          ).toISOString(),
          min_lat: bounds.getSouth(),
          max_lat: bounds.getNorth(),
          min_lon: bounds.getWest(),
          max_lon: bounds.getEast(),
          variables: selectedVariable,
        });

        const response = await fetch(`/weather-data?${params}`);
        const data = await response.json();

        updateMap(data, selectedVariable);
        updateSliderValues();
      }

      function updateMap(data, selectedVariable) {
        markers.clearLayers();

        const values = data.map((d) => d[selectedVariable]);
        const min = Math.min(...values);
        const max = Math.max(...values);

        data.forEach((point) => {
          const normalized = (point[selectedVariable] - min) / (max - min);
          const color = point.is_outlier
            ? "red"
            : `rgb(0, 0, ${Math.floor(255 * normalized)})`;

          const circle = L.circleMarker([point.x, point.y], {
            radius: 5,
            color: color,
            fillColor: color,
            fillOpacity: 0.7,
          });

          circle.bindPopup(`
                    <b>${selectedVariable}:</b> ${point[selectedVariable]}<br>
                    <b>Outlier:</b> ${point.is_outlier ? "Yes" : "No"}
                `);

          markers.addLayer(circle);
        });
      }

      // Initialize the map when the page loads
      window.onload = initMap;
    </script>
  </body>
</html>
